name: Monorepo Layered CI

on:
  push:
    branches: [ junior ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: 8.0.x
  BUILD_LAYERS: ${{ secrets.BUILD_LAYERS }}
  SONAR_HOST_URL: https://sonarcloud.io

jobs:

  ci:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # TIMER
      # -------------------------
      - name: ‚è± Start Timer
        run: echo "START=$(date +%s)" >> $GITHUB_ENV

      # -------------------------
      # CHECKOUT
      # -------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # -------------------------
      # JUNIOR BUILD
      # -------------------------
      - name: üß± Build Layers (Junior)
        if: github.event_name == 'push'
        run: |
          echo "Build order: $BUILD_LAYERS"

          for layer in $BUILD_LAYERS; do
            echo "‚ñ∂Ô∏è Building $layer"
            cd "$layer"
            dotnet restore
            dotnet build --no-restore
            cd ..
          done

      # -------------------------
      # SONAR (PR ONLY)
      # -------------------------
      - name: üîç Sonar Begin
        if: github.event_name == 'pull_request'
        run: |
          dotnet tool install --global dotnet-sonarscanner
          dotnet sonarscanner begin \
            /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
            /o:"${{ secrets.SONAR_ORG }}" \
            /d:sonar.login="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="$SONAR_HOST_URL"

      - name: üß± Build Layers (Sonar)
        if: github.event_name == 'pull_request'
        run: |
          for layer in $BUILD_LAYERS; do
            dotnet build "$layer"
          done

      - name: üîç Sonar End
        if: github.event_name == 'pull_request'
        run: dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

      # -------------------------
      # SONAR FAIL
      # -------------------------
      - name: ‚ùå Sonar Fail
        if: failure()
        run: |
          echo "SONAR fail"
          echo "Sonar URL: https://sonarcloud.io/dashboard?id=${{ secrets.SONAR_PROJECT_KEY }}"
          echo "Ba≈üarƒ±sƒ±z :("

      # -------------------------
      # MERGE MAIN (SONAR OK)
      # -------------------------
      - name: üîÄ Merge PR to Main
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr merge ${{ github.event.pull_request.number }} --merge --admin

      # -------------------------
      # FINAL RESULT
      # -------------------------
      - name: üéâ Final Result
        if: success()
        run: |
          END=$(date +%s)
          echo "Ba≈üarƒ±lƒ± :)"
          echo "Toplam S√ºre: $((END-START)) saniye"
