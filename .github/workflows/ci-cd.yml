name: Monorepo Layered CI

on:
  push:
    branches: [ junior ]
  pull_request:
    branches: [ main, junior, senior ]

env:
  DOTNET_VERSION: 8.0.x
  BUILD_LAYERS: ${{ secrets.BUILD_LAYERS }}
  SONAR_HOST_URL: https://sonarcloud.io

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # TIMER
      # -------------------------
      - name: â± Start Timer
        run: echo "START=$(date +%s)" >> $GITHUB_ENV

      # -------------------------
      # CHECKOUT (FULL HISTORY)
      # -------------------------
      - name: ðŸ“¥ Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------
      # SETUP .NET
      # -------------------------
      - name: ðŸ§© Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # -------------------------
      # JUNIOR BUILD (PUSH)
      # -------------------------
      - name: ðŸ§± Build Layers (Junior Push)
        if: github.event_name == 'push' && github.ref_name == 'junior'
        run: |
          for layer in $BUILD_LAYERS; do
            echo "â–¶ï¸ Building $layer"
            cd "$layer"
            dotnet restore
            dotnet build --no-restore
            cd ..
          done

      # =========================================================
      # SONAR â€” SADECE junior â†’ main PR
      # =========================================================

      # -------------------------
      # SONAR BEGIN
      # -------------------------
      - name: ðŸ” Sonar Begin (junior â†’ main)
        if: >
          github.event_name == 'pull_request' &&
          github.head_ref == 'junior' &&
          github.base_ref == 'main'
        env:
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet tool install --global dotnet-sonarscanner

          dotnet sonarscanner begin \
            /k:"$SONAR_PROJECT_KEY" \
            /o:"$SONAR_ORG" \
            /d:sonar.login="$SONAR_TOKEN" \
            /d:sonar.host.url="$SONAR_HOST_URL" \
            /d:sonar.pullrequest.key="${{ github.event.pull_request.number }}" \
            /d:sonar.pullrequest.branch="junior" \
            /d:sonar.pullrequest.base="main" \
            /d:sonar.newCode.referenceBranch="main" \
            /d:sonar.scm.provider=git \
            /d:sonar.sourceEncoding=UTF-8

      # -------------------------
      # BUILD FOR SONAR
      # -------------------------
      - name: ðŸ§± Build Layers (Sonar)
        if: >
          github.event_name == 'pull_request' &&
          github.head_ref == 'junior' &&
          github.base_ref == 'main'
        run: |
          for layer in $BUILD_LAYERS; do
            dotnet build "$layer"
          done

      # -------------------------
      # SONAR END
      # -------------------------
      - name: ðŸ” Sonar End (junior â†’ main)
        if: >
          github.event_name == 'pull_request' &&
          github.head_ref == 'junior' &&
          github.base_ref == 'main'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"

      # -------------------------
      # FINAL RESULT
      # -------------------------
      - name: ðŸŽ‰ Final Result
        if: success()
        run: |
          END=$(date +%s)
          echo "BaÅŸarÄ±lÄ± âœ…"
          echo "Toplam SÃ¼re: $((END-START)) saniye"