name: Monorepo Layered CI

on:
  push:
    branches: [ junior ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: 8.0.x
  BUILD_LAYERS: ${{ secrets.BUILD_LAYERS }}
  SONAR_HOST_URL: https://sonarcloud.io

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # TIMER
      # -------------------------
      - name: ‚è± Start Timer
        run: echo "START=$(date +%s)" >> $GITHUB_ENV

      # -------------------------
      # CHECKOUT
      # -------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v4

      - name: üß© Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # -------------------------
      # JUNIOR BUILD (push)
      # -------------------------
      - name: üß± Build Layers (Junior)
        if: github.event_name == 'push'
        run: |
          echo "Build order: $BUILD_LAYERS"
          for layer in $BUILD_LAYERS; do
            echo "‚ñ∂Ô∏è Building $layer"
            cd "$layer"
            dotnet restore
            dotnet build --no-restore
            cd ..
          done

      # -------------------------
      # SONAR BEGIN (PR)
      # -------------------------
      - name: üîç Sonar Begin
        if: github.event_name == 'pull_request'
        env:
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet tool install --global dotnet-sonarscanner

          dotnet sonarscanner begin \
            /k:"$SONAR_PROJECT_KEY" \
            /o:"$SONAR_ORG" \
            /d:sonar.login="$SONAR_TOKEN" \
            /d:sonar.host.url="$SONAR_HOST_URL" \
            /d:sonar.pullrequest.key="${{ github.event.pull_request.number }}" \
            /d:sonar.pullrequest.branch="${{ github.head_ref }}" \
            /d:sonar.pullrequest.base="${{ github.base_ref }}"

      # -------------------------
      # BUILD FOR SONAR
      # -------------------------
      - name: üß± Build Layers (Sonar)
        if: github.event_name == 'pull_request'
        run: |
          for layer in $BUILD_LAYERS; do
            dotnet build "$layer"
          done

      # -------------------------
      # SONAR END
      # -------------------------
      - name: üîç Sonar End
        if: github.event_name == 'pull_request'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"

      # -------------------------
      # FINAL RESULT
      # -------------------------
      - name: üéâ Final Result
        if: success()
        run: |
          END=$(date +%s)
          echo "Ba≈üarƒ±lƒ± ‚úÖ"
          echo "Toplam S√ºre: $((END-START)) saniye"