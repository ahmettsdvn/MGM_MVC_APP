name: Monorepo Layered CI

on:
  # Junior'a direkt push ‚Üí sadece build
  push:
    branches:
      - junior

  # Sadece junior ‚Üí main PR
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: 8.0.x
  BUILD_LAYERS: ${{ secrets.BUILD_LAYERS }}
  SONAR_HOST_URL: https://sonarcloud.io

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # TIMER
      # -------------------------
      - name: ‚è± Start Timer
        run: echo "START=$(date +%s)" >> $GITHUB_ENV

      # -------------------------
      # CHECKOUT
      # -------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------
      # SETUP .NET
      # -------------------------
      - name: üß© Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # =========================================================
      # JUNIOR PUSH ‚Üí BUILD
      # =========================================================
      - name: üß± Build Layers (Junior Push)
        if: github.event_name == 'push'
        run: |
          for layer in $BUILD_LAYERS; do
            echo "‚ñ∂Ô∏è Building $layer"
            cd "$layer"
            dotnet restore
            dotnet build --no-restore
            cd ..
          done

      # =========================================================
      # SONAR ‚Äî SADECE junior ‚Üí main PR
      # =========================================================

      - name: üîç Sonar Begin (junior ‚Üí main)
        if: github.event_name == 'pull_request' && github.head_ref == 'junior'
        env:
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet tool install --global dotnet-sonarscanner

          dotnet sonarscanner begin \
            /k:"$SONAR_PROJECT_KEY" \
            /o:"$SONAR_ORG" \
            /d:sonar.login="$SONAR_TOKEN" \
            /d:sonar.host.url="$SONAR_HOST_URL" \
            /d:sonar.pullrequest.key="${{ github.event.pull_request.number }}" \
            /d:sonar.pullrequest.branch="junior" \
            /d:sonar.pullrequest.base="main" \
            /d:sonar.newCode.referenceBranch="main"

      - name: üß± Build Layers (Sonar)
        if: github.event_name == 'pull_request' && github.head_ref == 'junior'
        run: |
          for layer in $BUILD_LAYERS; do
            dotnet build "$layer"
          done

      - name: üîç Sonar End (junior ‚Üí main)
        if: github.event_name == 'pull_request' && github.head_ref == 'junior'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"

      # -------------------------
      # FINAL RESULT
      # -------------------------
      - name: üéâ Final Result
        if: success()
        run: |
          END=$(date +%s)
          echo "Ba≈üarƒ±lƒ± Aksiyon ‚úÖ"
          echo "Toplam S√ºre: $((END-START)) saniye"
